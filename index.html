<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>PINE Tycoon – Головна</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg: #f4f4f4;
      --text: #222;
      --card-bg: #ffffff;
      --accent: #383837;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      position: relative;
      overflow-x: hidden;
    }

    /* Анімація появи */
    header,
    .card {
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.6s ease, transform 0.6s ease;
    }

    body.loaded header,
    body.loaded .card {
      opacity: 1;
      transform: translateY(0);
    }

    /* Сніг */
    #snowCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }

    header,
    main,
    footer {
      position: relative;
      z-index: 1;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: #383837;
      color: #fff;
    }

    .logo {
      font-weight: 700;
      letter-spacing: 1px;
    }

    nav {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    nav a {
      text-decoration: none;
      color: #fff;
      padding: 6px 12px;
      border-radius: 6px;
      background: rgba(255,255,255,0.08);
      font-size: 14px;
      transition:
        transform 0.2s ease,
        background 0.2s ease,
        box-shadow 0.2s ease;
    }

    nav a:hover {
      background: rgba(255,255,255,0.2);
      transform: translateY(-1px) scale(1.03);
      box-shadow: 0 4px 10px rgba(0,0,0,0.18);
    }

    .auth-buttons button {
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      margin-left: 6px;
      cursor: pointer;
      font-size: 14px;
      background: #ffffff;
      color: #383837;
      transition:
        transform 0.2s ease,
        background 0.2s ease,
        box-shadow 0.2s ease;
    }

    .auth-buttons button:hover {
      background: #f1f1f1;
      transform: translateY(-1px) scale(1.03);
      box-shadow: 0 4px 10px rgba(0,0,0,0.18);
    }

    main {
      max-width: 900px;
      margin: 30px auto;
      padding: 0 15px 30px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    .hero {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .hero img {
      max-width: 260px;
      border-radius: 12px;
      border: 3px solid #383837;
    }

    .hero-top {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
    }

    .hero-text h1 {
      margin: 0 0 8px;
      font-size: 26px;
      color: #383837;
    }

    .hero-text p {
      margin: 4px 0;
    }

    .status-box {
      font-size: 14px;
      color: #555;
    }

    .blog-section h2 {
      margin-top: 0;
      margin-bottom: 8px;
    }

    .blog-section p {
      margin-top: 4px;
    }

    .auth-forms {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }

    form {
      flex: 1;
      min-width: 250px;
    }

    form h3 {
      margin-top: 0;
      margin-bottom: 8px;
    }

    label {
      display: block;
      font-size: 13px;
      margin-top: 6px;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"] {
      width: 100%;
      box-sizing: border-box;
      margin-top: 2px;
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }

    form button[type="submit"],
    #deleteUserBtn,
    #logoutBtn {
      margin-top: 10px;
      padding: 7px 12px;
      border-radius: 6px;
      border: none;
      background: #383837;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      transition:
        background 0.2s ease,
        transform 0.2s ease,
        box-shadow 0.2s ease;
    }

    form button[type="submit"]:hover,
    #deleteUserBtn:hover,
    #logoutBtn:hover {
      background: #222;
      transform: translateY(-1px) scale(1.03);
      box-shadow: 0 4px 10px rgba(0,0,0,0.18);
    }

    #deleteUserBtn {
      background: #e53935;
    }
    #deleteUserBtn:hover {
      background: #c62828;
    }

    #logoutBtn {
      background: #e74c3c;
    }
    #logoutBtn:hover {
      background: #c0392b;
    }

    .small-text {
      font-size: 12px;
      color: #777;
      margin-top: 4px;
    }

    .hidden {
      display: none !important;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .avatar {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      border: 2px solid #383837;
    }

    .user-name {
      font-weight: 600;
    }

    /* Admin panel */

    #adminPanel {
      margin-top: 16px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #e57373;
      background: #ffebee;
      font-size: 14px;
    }

    #adminPanel h3 {
      margin-top: 0;
      margin-bottom: 6px;
      color: #c62828;
    }

    #deleteUserInput {
      width: 100%;
      box-sizing: border-box;
      margin-top: 4px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    #deleteUserStatus {
      margin-top: 6px;
      font-size: 13px;
    }

    /* Онлайн гравці */

    #onlineList {
      list-style: none;
      padding-left: 0;
      margin: 6px 0 0;
    }

    #onlineList li {
      font-size: 14px;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .online-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: #95a5a6;
      flex-shrink: 0;
    }

    footer {
      text-align: center;
      padding: 12px 10px;
      background: #383837;
      color: #fff;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">PINE Tycoon</div>
    <nav>
      <a href="index.html">Головна</a>
      <a href="game.html">Грати!</a>
      <a href="#blog">Блог</a>

      <div class="auth-buttons" id="authButtons">
        <button id="showAuthBtn">Sign in / Sign up</button>
      </div>

      <div class="user-info hidden" id="userInfo">
        <div class="avatar" id="userAvatar"></div>
        <span class="user-name" id="userName"></span>
        <button id="logoutBtn">Вийти</button>
      </div>
    </nav>
  </header>

  <!-- Сніг -->
  <canvas id="snowCanvas"></canvas>

  <main>
    <!-- Головний блок про гру -->
    <section class="card hero">
      <div class="hero-top">
        <img
          src="https://learn.logikaschool.com/uploads/student/4796102/6929d42d4c366.png"
          alt="PINE Tycoon лого"
        />
        <div class="hero-text">
          <h1>PINE Tycoon</h1>
          <p>
            Ласкаво просимо до зимового тайкуна, де ви рубаєте дерева, будуєте
            дерев’яне село та намагаєтесь не замерзнути в заметілі 
          </p>
          <p class="status-box">
            Поточна версія: <b>1.0 – мультиплеєрна альфа</b><br />
            Додано: систему акаунтів, синхронізацію гравців та базовий мультиплеєр.
          </p>
        </div>
      </div>
    </section>

    <!-- Гравці онлайн -->
    <section class="card" id="onlineCard">
      <h2>Гравці онлайн</h2>
      <p id="onlineSummary" class="small-text">Завантаження...</p>
      <ul id="onlineList"></ul>
    </section>

    <!-- Блок для реєстрації / входу -->
    <section class="card" id="authCard">
      <h2>Акаунт</h2>
      <p class="small-text">
        Створи акаунт, щоб грати під своїм ім’ям у мультиплеєрі, а також у майбутньому залишати коментарі, додавати друзів тощо.
      </p>

      <div class="auth-forms">
        <!-- Реєстрація -->
        <form id="signupForm">
          <h3>Реєстрація</h3>
          <label>
            Нікнейм (буде видно у грі)
            <input type="text" id="signupName" required />
          </label>
          <label>
            Email
            <input type="email" id="signupEmail" required />
          </label>
          <label>
            Пароль
            <input type="password" id="signupPassword" required />
          </label>
          <button type="submit">Створити акаунт</button>
          <div class="small-text">
            Порада: використай свій існуючий нік, наприклад <b>davyd3102</b>.
          </div>
          <div id="signupStatus" class="small-text"></div>
        </form>

        <!-- Вхід -->
        <form id="loginForm">
          <h3>Вхід</h3>
          <label>
            Email
            <input type="email" id="loginEmail" required />
          </label>
          <label>
            Пароль
            <input type="password" id="loginPassword" required />
          </label>
          <button type="submit">Увійти</button>
          <div id="loginStatus" class="small-text"></div>
        </form>
      </div>
    </section>

    <!-- Блок для залогіненого користувача + адмін-панель -->
    <section class="card hidden" id="loggedCard">
      <h2>Привіт, <span id="welcomeName">гравцю</span>!</h2>
      <p>
        Ти увійшов у систему. Тепер, коли ти запускаєш гру
        через кнопку <b>Грати!</b>, мультиплеєр зможе розпізнати твоє ім’я.
      </p>

      <!-- Адмін-панель лише для davyd3102 -->
      <div id="adminPanel" class="hidden">
        <h3>Admin панель (тільки для davyd3102)</h3>
        <p class="small-text">
          Тут ти можеш видалити користувача з колекції <b>users</b> та <b>gamePlayers</b>.
          Це ніби "бан" – профіль зникне з сайту та з мультиплеєра.
        </p>

        <label>
          Ім’я користувача для видалення:
          <input id="deleteUserInput" type="text" placeholder="Наприклад: 3102" />
        </label>

        <button id="deleteUserBtn">Видалити користувача</button>
        <div id="deleteUserStatus"></div>
      </div>
    </section>

    <!-- Блог -->
    <section class="card blog-section" id="blog">
      <h2>Блог</h2>
      <p><i>Останнє оновлення:</i></p>
      <ul>
        <li>Додано систему акаунтів на Firebase.</li>
        <li>Підключено мультиплеєр між гравцями (перша альфа).</li>
        <li>Підготовлено адмін-панель для <b>davyd3102</b> ✨</li>
        <li>Додано снігову анімацію та відображення гравців онлайн.</li>
      </ul>
      <p>Незабаром тут з’являться нотатки про розробку, зміни балансу та нові будівлі.</p>
    </section>
  </main>

  <footer>
    © 2025 PINE Tycoon — бета-версія гри з мультиплеєром
  </footer>

  <!-- Firebase + логіка акаунтів, адмінки, онлайн-статусу і снігу -->
  <script type="module">
    // Анімація появи сторінки
    window.addEventListener("load", () => {
      document.body.classList.add("loaded");
    });

    // Синій сніг
    const snowCanvas = document.getElementById("snowCanvas");
    const snowCtx = snowCanvas.getContext("2d");
    let snowflakes = [];
    let lastSnowTime = 0;

    function resizeSnow() {
      snowCanvas.width = window.innerWidth;
      snowCanvas.height = window.innerHeight;
    }

    function initSnow(count = 140) {
      resizeSnow();
      snowflakes = [];
      for (let i = 0; i < count; i++) {
        snowflakes.push({
          x: Math.random() * snowCanvas.width,
          y: Math.random() * snowCanvas.height,
          r: 1 + Math.random() * 1.8,
          speed: 20 + Math.random() * 40,
          drift: -15 + Math.random() * 30
        });
      }
    }

    function snowLoop(timestamp) {
      const dt = (timestamp - lastSnowTime) / 1000 || 0;
      lastSnowTime = timestamp;

      snowCtx.clearRect(0, 0, snowCanvas.width, snowCanvas.height);
      snowCtx.fillStyle = "rgba(80,160,255,0.9)";

      for (const f of snowflakes) {
        f.y += f.speed * dt;
        f.x += f.drift * dt;

        if (f.y > snowCanvas.height + f.r) {
          f.y = -f.r;
          f.x = Math.random() * snowCanvas.width;
        }
        if (f.x < -10) f.x = snowCanvas.width + 10;
        if (f.x > snowCanvas.width + 10) f.x = -10;

        snowCtx.beginPath();
        snowCtx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
        snowCtx.fill();
      }

      requestAnimationFrame(snowLoop);
    }

    initSnow(150);
    requestAnimationFrame(snowLoop);
    window.addEventListener("resize", () => {
      resizeSnow();
      initSnow(snowflakes.length || 150);
    });

    // -------- Firebase --------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      setDoc,
      getDocs,
      query,
      where,
      deleteDoc,
      serverTimestamp,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDZEwAbFwLQXxlkkmuMKBFof2J3OE02Egs",
      authDomain: "pine-tycoon.firebaseapp.com",
      projectId: "pine-tycoon",
      storageBucket: "pine-tycoon.firebasestorage.app",
      messagingSenderId: "949986190236",
      appId: "1:949986190236:web:4f5d50078326f5c1981e59",
      measurementId: "G-2DY6KSY4G7"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM-елементи
    const authCard     = document.getElementById("authCard");
    const loggedCard   = document.getElementById("loggedCard");
    const welcomeName  = document.getElementById("welcomeName");

    const signupForm   = document.getElementById("signupForm");
    const signupName   = document.getElementById("signupName");
    const signupEmail  = document.getElementById("signupEmail");
    const signupPass   = document.getElementById("signupPassword");
    const signupStatus = document.getElementById("signupStatus");

    const loginForm    = document.getElementById("loginForm");
    const loginEmail   = document.getElementById("loginEmail");
    const loginPass    = document.getElementById("loginPassword");
    const loginStatus  = document.getElementById("loginStatus");

    const authButtons  = document.getElementById("authButtons");
    const showAuthBtn  = document.getElementById("showAuthBtn");
    const userInfo     = document.getElementById("userInfo");
    const userAvatar   = document.getElementById("userAvatar");
    const userNameEl   = document.getElementById("userName");
    const logoutBtn    = document.getElementById("logoutBtn");

    const adminPanel       = document.getElementById("adminPanel");
    const deleteUserInput  = document.getElementById("deleteUserInput");
    const deleteUserBtn    = document.getElementById("deleteUserBtn");
    const deleteUserStatus = document.getElementById("deleteUserStatus");

    const onlineSummary = document.getElementById("onlineSummary");
    const onlineListEl  = document.getElementById("onlineList");

    // Показати/сховати блок авторизації по кнопці в хедері
    if (showAuthBtn) {
      showAuthBtn.addEventListener("click", () => {
        if (authCard.classList.contains("hidden")) {
          authCard.classList.remove("hidden");
        } else {
          authCard.classList.add("hidden");
        }
      });
    }

    // Реєстрація
    if (signupForm) {
      signupForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        signupStatus.textContent = "";

        const name = signupName.value.trim();
        const email = signupEmail.value.trim();
        const pass = signupPass.value.trim();

        if (!name) {
          signupStatus.textContent = "Введи нікнейм.";
          return;
        }

        try {
          const cred = await createUserWithEmailAndPassword(auth, email, pass);
          await updateProfile(cred.user, { displayName: name });

          const userRef = doc(db, "users", cred.user.uid);
          await setDoc(userRef, {
            name,
            email,
            createdAt: serverTimestamp()
          });

          signupStatus.textContent = "Акаунт створено! Ти увійшов як " + name;
          signupForm.reset();
        } catch (err) {
          console.error(err);
          signupStatus.textContent = "Помилка реєстрації: " + (err.code || err.message);
        }
      });
    }

    // Вхід
    if (loginForm) {
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        loginStatus.textContent = "";

        const email = loginEmail.value.trim();
        const pass = loginPass.value.trim();

        try {
          await signInWithEmailAndPassword(auth, email, pass);
          loginStatus.textContent = "Успішний вхід!";
          loginForm.reset();
        } catch (err) {
          console.error(err);
          loginStatus.textContent = "Помилка входу: " + (err.code || err.message);
        }
      });
    }

    // Вихід
    if (logoutBtn) {
      logoutBtn.addEventListener("click", async () => {
        try {
          await signOut(auth);
        } catch (err) {
          console.error(err);
        }
      });
    }

    // onAuthStateChanged — оновлюємо UI + адмін-панель
    onAuthStateChanged(auth, (user) => {
      if (user) {
        const name = user.displayName || "Гравець";
        welcomeName.textContent = name;
        userNameEl.textContent  = name;

        const firstLetter = name.charAt(0).toUpperCase() || "P";
        userAvatar.style.backgroundImage =
          "url('https://dummyimage.com/100x100/383837/ffffff&text=" + encodeURIComponent(firstLetter) + "')";

        authButtons.classList.add("hidden");
        userInfo.classList.remove("hidden");
        authCard.classList.add("hidden");
        loggedCard.classList.remove("hidden");

        if (name === "davyd3102") {
          adminPanel.classList.remove("hidden");
        } else {
          adminPanel.classList.add("hidden");
        }
      } else {
        authButtons.classList.remove("hidden");
        userInfo.classList.add("hidden");
        loggedCard.classList.add("hidden");
      }
    });

    // Admin-panel: видалити користувача
    if (deleteUserBtn) {
      deleteUserBtn.addEventListener("click", async () => {
        const name = deleteUserInput.value.trim();
        deleteUserStatus.textContent = "";

        if (!name) {
          deleteUserStatus.textContent = "Введи ім'я користувача.";
          return;
        }

        deleteUserStatus.textContent = "Шукаю користувача '" + name + "'...";

        try {
          const usersRef = collection(db, "users");
          const q = query(usersRef, where("name", "==", name));
          const snap = await getDocs(q);

          if (snap.empty) {
            deleteUserStatus.textContent = "Користувача з таким ім'ям не знайдено.";
            return;
          }

          let deletedCount = 0;

          for (const userDoc of snap.docs) {
            const uid = userDoc.id;
            await deleteDoc(userDoc.ref);

            const gpRef = doc(db, "gamePlayers", uid);
            await deleteDoc(gpRef).catch(() => {});
            deletedCount++;
          }

          deleteUserStatus.textContent =
            "Користувача(ів) '" + name + "' видалено: " + deletedCount + ".";
          deleteUserInput.value = "";
        } catch (err) {
          console.error(err);
          deleteUserStatus.textContent = "Сталася помилка при видаленні.";
        }
      });
    }

    // Онлайн гравці (по колекції gamePlayers)
    const gamePlayersCol = collection(db, "gamePlayers");
    const MAX_INACTIVE_MS = 30000; // 30 секунд

    if (onlineSummary && onlineListEl) {
      onSnapshot(
        gamePlayersCol,
        (snapshot) => {
          const now = Date.now();
          const players = [];

          snapshot.forEach((docSnap) => {
            const data = docSnap.data() || {};
            const name = data.name || "Гравець";
            const updatedAt = data.updatedAt && data.updatedAt.toDate
              ? data.updatedAt.toDate().getTime()
              : 0;
            const online = updatedAt && (now - updatedAt) < MAX_INACTIVE_MS;
            players.push({ name, online });
          });

          if (players.length === 0) {
            onlineSummary.textContent = "Ніхто зараз не у грі.";
            onlineListEl.innerHTML = "";
            return;
          }

          const onlineCount = players.filter(p => p.online).length;
          onlineSummary.textContent =
            "Онлайн у грі зараз: " + onlineCount + " із " + players.length;

          players.sort((a, b) => a.name.localeCompare(b.name));
          onlineListEl.innerHTML = "";

          for (const p of players) {
            const li = document.createElement("li");
            const dot = document.createElement("span");
            dot.className = "online-dot";
            dot.style.backgroundColor = p.online ? "#2ecc71" : "#95a5a6";
            li.appendChild(dot);
            li.appendChild(document.createTextNode(
              p.name + (p.online ? " — у грі" : " — офлайн")
            ));
            onlineListEl.appendChild(li);
          }
        },
        (err) => {
          console.error(err);
          onlineSummary.textContent = "Не вдалося завантажити статус гравців.";
        }
      );
    }
  </script>
</body>
</html>
