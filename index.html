<script>
  (function () {
    const DEFAULT_AVATAR = "https://learn.logikaschool.com/uploads/student/4796102/692acc8996fdc.png";
    const DAVYD_AVATAR = "https://learn.logikaschool.com/uploads/student/4796102/692acfc896c23.png";

    function getUsers() {
      const raw = localStorage.getItem("pineUsers");
      if (!raw) return {};
      try {
        const obj = JSON.parse(raw);
        return obj && typeof obj === "object" ? obj : {};
      } catch (e) {
        return {};
      }
    }

    function getComments() {
      const raw = localStorage.getItem("pineBlogComments");
      if (!raw) return [];
      try {
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch (e) {
        return [];
      }
    }

    function saveComments(comments) {
      localStorage.setItem("pineBlogComments", JSON.stringify(comments));
    }

    const nameDisplay = document.getElementById("userNameDisplay");
    const welcomeText = document.getElementById("welcomeText");
    const avatarImg = document.querySelector(".user-avatar");

    const currentName = localStorage.getItem("pineUserName");
    const users = getUsers();

    let nameToShow = "Guest";
    if (currentName && users[currentName]) {
      nameToShow = currentName;
    }

    if (nameToShow === "Guest") {
      nameDisplay.textContent = "Гість";
      welcomeText.textContent = "Welcome Guest";
    } else {
      nameDisplay.textContent = nameToShow;
      welcomeText.textContent = "Welcome " + nameToShow;
    }

    if (nameToShow === "davyd3102") {
      avatarImg.src = DAVYD_AVATAR;
    } else {
      avatarImg.src = DEFAULT_AVATAR;
    }

    // ----- Коментарі -----
    const commentsListEl = document.getElementById("commentsList");
    const noCommentsText = document.getElementById("noCommentsText");
    const commentFormWrapper = document.getElementById("commentFormWrapper");

    function renderComments() {
      const comments = getComments();
      commentsListEl.innerHTML = "";
      if (!comments.length) {
        noCommentsText.style.display = "block";
        return;
      }
      noCommentsText.style.display = "none";

      comments.forEach((c) => {
        const li = document.createElement("li");
        li.className = "comment-item";

        const authorDiv = document.createElement("div");
        authorDiv.className = "comment-author";
        authorDiv.textContent = c.author;

        const textDiv = document.createElement("div");
        textDiv.className = "comment-text";
        textDiv.textContent = c.text;

        li.appendChild(authorDiv);
        li.appendChild(textDiv);

        commentsListEl.appendChild(li);
      });
    }

    renderComments();

    // Форма коментарів тільки для davyd3102
    if (nameToShow === "davyd3102") {
      commentFormWrapper.innerHTML = `
        <form id="commentForm" class="comment-form">
          <label>
            Ваш коментар:
            <textarea id="commentText" required></textarea>
          </label>
          <button type="submit">Надіслати</button>
        </form>
      `;

      const commentForm = document.getElementById("commentForm");
      const commentTextEl = document.getElementById("commentText");

      commentForm.addEventListener("submit", function (e) {
        e.preventDefault();
        const text = commentTextEl.value.trim();
        if (!text) return;

        const comments = getComments();
        comments.push({
          author: nameToShow,
          text: text,
          time: Date.now(),
        });
        saveComments(comments);
        commentTextEl.value = "";
        renderComments();
      });
    } else {
      commentFormWrapper.innerHTML = `
        <p class="comment-info">
          Щоб залишати коментарі, потрібно зайти як <strong>davyd3102</strong>.
        </p>
      `;
    }
  })();
</script>
